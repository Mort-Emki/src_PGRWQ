# PG-RWQ: 基于物理约束的递归水质预测模型

## 介绍

PG-RWQ（Physics-Guided Recursive Water Quality）是一种用于河网水质预测的创新模型。与传统的深度学习模型不同，PG-RWQ 将物理约束和基于路径的递归建模相结合，以提高模型的可解释性和预测精度。该模型建模局部汇水区的贡献，并使用递归路径计算来捕捉上游河段的水质影响。

该模型的目标是预测水质指标（如总氮 TN 和总磷 TP），通过显式建模上游河段的影响和本地汇水区的负荷贡献来实现水质的高精度预测。这种混合方法确保了预测结果在物理水质动态方面的一致性，同时结合了深度学习的灵活性和学习能力。

## 算法思想、创新

- 物理约束的递归建模：将上游的水质浓度和本地负荷的贡献分离，并通过递归计算路径来捕捉上游的影响。
- 本地负荷分离：将本地汇水区的负荷贡献与上游河段的汇流区分开，并用深度学习方法对本地负荷贡献进行拟合。
- 高效的汇流路径：通过递归的路径方法，模型从headbasin（源头）到河段的终点，显式建模了物理路径的依赖关系。

### 一、更科学、更清晰、更准确

#### 1. 更科学
"更科学"主要体现在对水质形成机理的明确分解，以及对河流网络结构与物理过程的合理融入。通过将河段水质拆分为"上游汇入贡献"与"本地贡献(local E)"两部分，这个框架在模型结构上体现了质量守恒和流域污染物输移规律的本质逻辑。它既兼顾了河道衰减机理和流量交换的科学原理，也为后续采用数据驱动方式学习未被显式刻画的本地过程留出了空间。

#### 2. 更清晰
"更清晰"主要体现在算法思路与物理含义之间的对应关系非常直观：
* 对于任意河段，算法明确显示上游传递的污染物量以及本地新增或削减的量，二者之和构成最终观测到的河道浓度。
* 这种"拆分-组合"的逻辑能让研究者在迭代过程和结果解析时，清晰地了解每条河段的"上游输入"与"本地修正"各占多少份额，避免了在纯黑箱模型中难以理解不同因素权重的困境。

#### 3. 更准确
该框架"更准确"的特点源于其能够将不同河段的空间异质性与上游累积效应纳入迭代环节；当某些河段存在较强的本地排放时，模型会将其反映到local E中，不会被简单地平均化或忽略。同时，它融合了监测数据（或模拟数据）与水文-水质机理，保证了在**数据不完备时**，也能通过迭代更新来逼近更真实的局部贡献，从而使整体流域模拟精度有了更坚实的保证。

### 二、兼具机理模型与数据驱动模型的优点

#### 1. 来自机理模型的优势
传统机理模型（process-based model）通常拥有明确的物理约束与机理假设，如水量平衡、污染物在河道中的衰减规律等。这些知识不仅提供了解释力，也能有效限制模型的自由度，避免在数据稀缺时出现过度拟合。这个算法框架同样遵循了质量守恒与跨段衰减的基本规律，使得对"上游负荷 + 局部贡献 = 当地水质"这一关系有了可物理解释的基础。

#### 2. 来自数据驱动模型的优势
纯数据驱动模型在处理高维非线性关系、缺乏明确机理假设时，往往能挖掘潜在的复杂关联。但其挑战在于可解释性较弱，或者需要庞大的训练数据方可得到较好效果。本算法框架将数据驱动技术（如多元回归、随机森林、LSTM、informer等）用于对local E这一"剩余项"的学习，既保留机理模型对主要过程的刻画，又将无法通过简化公式直接表达的局部效应交由数据驱动模型去学习，从而**兼具**了物理合理性和数据挖掘能力。

#### 3. 对比于纯机理或纯数据模型
与纯机理模型相比，该算法不必事无巨细地将每一个局部过程都穷举出来——如果对某一子流域或河段的具体生化反应缺乏精确参数，也可以让数据驱动部分自动学习、补足；与纯数据模型相比，又不会像"黑箱"那样对河道网络的结构性知识和常规衰减机理视而不见，而是在更高的起点上进行拟合与推断。

### 三、对比图神经网络的优势与关系

#### 1. 与图神经网络的相似点
图神经网络（Graph Neural Network, GNN）在处理河网这样的拓扑结构时，通常会"消息传递"各节点（河段或监测站点）之间的信息，以反映空间关联。本算法与GNN类似之处在于：
* 都强调河网结构的重要性；
* 都在"节点-边"层面进行迭代或递推计算；
* 都依赖一定的输入特征与观测输出进行参数学习。

#### 2. 显式物理过程与领域知识
然而，该算法最大的特色在于，它对部分关键河道过程做了**显式处理**。通过保留系数 R(Ωj,Ωi) 来描述跨段衰减，以"上游河段、本地贡献"相加的方式计算水质。这些过程本质上是领域专家在水质模拟中普遍认可的核心机理，将其内置于模型结构中后，只需让数据驱动模块集中学习那些尚无法直接量化或尚未完全掌握的环节，避免GNN可能产生的"大一统黑箱"。 

换言之，如果将GNN看作是一种"结构化的黑箱"，那么这个算法框架就像是**"半白箱"**：既利用了对河道网络拓扑的结构化理解，又在关键过程上嵌入了专业机理公式，大大提高了可解释性与可控性。

#### 3. 与GNN的互补或演进
从某种程度上说，这个框架可以看作对图神经网络的**一种改良或变形**：它将"message passing"中的衰减、运移等环节显性化；在需要更复杂的局部关系时，再让数据驱动模型去拟合这些剩余项（local E）。若在更大规模或更分散的数据场景下，需要进一步融入邻接关系和空间依赖，也可以把GNN的思想与本模型合并，进一步提升其对网络复杂性的建模能力。

### 四、分离local E并进行无监督学习的亮点

#### 1. local E的提出意义
在传统水质模拟中，若只看"上游水质 + 下游观察"之间的差异，常常很难说明哪些本地过程或本地负荷确切地贡献了多少。通过明确拆分出local E(Ωi)，并在迭代中专门训练或回归这项值，可以更系统地量化"该河段所在子流域的净贡献"，实现对每条河段的本地环境及人类活动的独立评估。

#### 2. 无监督学习思路
local E在概念上是一个"不存在直接监测标签"的量，因为无法在现实中直接测量某条河段的"本地净贡献"。将其拆分并建立迭代学习过程，相当于一种**无监督或自监督**的理念——仅仅依赖下游监测站点的整体观测值，通过反复迭代来逼近各河段局部效应，使得最终模型中每个local E(Ωi)都与真实水质观测相一致。这种方式既尊重了大型河网的整体平衡，也在子流域层面挖掘到了潜在的局部差异性。

#### 3. 在治理与预测中的应用前景
一旦将local E(Ωi)稳定估计到较高精度，便能在更细尺度上分析：哪些河段最亟需治理；或者在不同场景（气候、土地利用变化）下，这些河段的"本地净贡献"会随之如何变化。这对生态环境管理决策提供了很具实用价值的支撑——既能掌握全域总体趋势，也能锁定局部核心问题区，进而制订更有针对性的管理策略。

### 五、深层价值
#### 1.精细刻画本地污染来源与过程
很多传统的水质模拟只关心“上游汇入负荷”与“全河段观测到的最终浓度”之间的差异，但未必能细分到是哪一部分是地表径流、哪一部分是内部生化反应或人为点源排放。通过local 𝐸，可以将这些本地因素统一地、数据驱动地汇总为一个“净效应”，而不再与上游的传输和河道常规衰减过程混在一起。这对制定精细化的污染治理策略十分关键——我知道哪些河段的本地贡献显著高，需要优先治理或调整产业结构。

#### 2.为不完全监测网络提供补充推断能力
在许多流域，监测站点的覆盖往往不足，无法在每条河段的上下游边界都设置观测。通过将上游影响和本地影响分开，只要有在一定位置的实测数据，就能在迭代训练过程中“反推出”本地的“隐含”贡献。即使某河段本身并无直接监测站点，通过在系统中相似河段通过迭代训练得到的推断local E的模型，应用在无监测的河段，也可以根据输入特征推断出这些河段的local E。通过local E的汇流算法，也可以同时得到该河段的水质浓度推理结果。

#### 3.框架可扩展、与其他方法的结合
local E通过数据驱动模型在迭代中得到，不是一个固定函数，而是可以用回归模型、随机森林、LSTM等多种数据驱动技术去模拟的“待求量”。这让模型具有很强的灵活性：

当拥有大量时空数据或高分辨率的空间信息时，可以采用更复杂的深度学习模型来挖掘非线性关系；

当数据相对较少或者需要可解释性时，可以采用多元回归或简单机器学习算法，获得更透明的结果。
这种灵活性还能让研究者分层、分类地建立不同类型河段的局部模型，从而得到更符合实际情况的水质预测。

#### 4.为更细致的研究提供基础量
local E的存在使我们能单独评估“除了河道基础衰减(或吸收速率)以外”的所有本地过程，如：

本地地表径流：耕地施肥量、降雨强度等带来的污染；

点源或面源排放：工业废水、生活污水、农业面源污染等；

河道微环境中的生化过程：河道泥沙对磷的吸附解吸、微生物群落在高氮环境下的动态响应等。

可以针对这些具体过程作针对性研究，判断哪些作用最强，然后再为流域管理提供更细致的调控手段。

#### 5.流域污染的整体溯源和优化
当我把整个区域中所有河段的local E都估计好，就能生成一幅清晰的“污染贡献地图”。基于这个地图，可以：

找出对下游水质影响最大的若干本地子流域；

评估如何通过治理关键河段或干预特定子流域，就能最大限度地改善整体水质；

更好地模拟在不同场景下（水文条件变化、土地利用转变、气候变化等），各个河段的local E如何演化。


需要加强的方面：

（1）边界条件和其他外部变量：如气候、土地利用剧变、极端事件可能导致保留系数变化，需要扩展或动态地处理；

（2）对局部过程的更细颗粒度解释：local E虽能量化总贡献，但若要分解成“面源+点源+河道微环境+沉积物交互”等，需要后续更细致的研究

<!-- ## 符号表

| **符号** | **含义** |
|----------|----------|
| $\Omega_i$ | 第 $i$ 个汇水区 |
| $y_t^{\text{up}}(\Omega_i)$ | 上游汇流对 $\Omega_i$ 的水质贡献 |
| $Q(\Omega_i)$ | 汇水区 $\Omega_i$ 的流量 |
| $N_t(\Omega_i)$ | 汇水区 $\Omega_i$ 的污染负荷 |
| $R(\Omega_j, \Omega_i)$ | 从 $\Omega_j$ 到 $\Omega_i$ 的边权重 |
| $L_t(\Omega_i, \Omega_j)$ | 从 $\Omega_j$ 到 $\Omega_i$ 的负荷 |
| $A_n$ | 预测器模型 |
| $\mathcal{L}$ | 损失函数 | -->

## 算法使用到的水文学、环境学的知识与概念

- 汇水区：河段的上游流入的区域，影响流入该河段的水质和流量。
- 水质指标：目标变量，如总氮（TN）和总磷（TP）。
- 负荷分解：将本地负荷（来自本地汇水区的排放）和上游流入的水质分离。
- 路径依赖：下游河段的水质不仅依赖于上游河段的水质，还依赖于本地的负荷贡献。

## 算法

### 算法框架

- 算法的核心思想是，将河段的水质显示分解为来自于上游河段的水的水质汇入的影响和河段自身集水区的影响。对于河段$\Omega_i$，其水质构成可以分解上游汇入水的影响部分$y^{\text{up}}(\Omega_i)$以及本河段的影响部分$E(\Omega_i)$。从实际含义而言，河段自身集水区的影响主要包括本集水区的地表径流水质，也包括集水区的气候、属性等对于整体水质的综合影响等。

$$y(\Omega_i) = y^{\text{up}}(\Omega_i) + E(\Omega_i)$$

已有应用数据驱动方法研究河流水质的研究中，本质是通过训练数据驱动模型A，根据流域的特征去拟合流域的水质，即$ A(feature \enspace of \enspace \Omega_i) \approx y(\Omega_i) $。这种方法尺度较粗，忽略了河流在河道中的传播，对于中间河段的水质预测不够清晰准确科学，除掉源头独立流域，对于流域整体的水质预测也较为粗糙。另外，为了尽量减少河道传播的复杂关系，此类方法在训练时往往采用源头独立流域，但是因为河流的水质监测数据基本不可能位于源头河段，这种方法还是难以得到准确的驱动数据与水质间清晰模型，而根据源头独立流域训练得到的模型推广到其他较大流域的过程也缺乏科学严谨性。为此，本算法考虑仅采用数据驱动模型去拟合河段所在独立catchment的水质影响。即$ A(feature \enspace of \enspace \Omega_i) \approx E(\Omega_i)$，再通过考虑降解的传播汇流算法，从源头河段开始沿河道传播结构逐层递推计算得到所有河段的水质。

- 目标：对于任意河段$\Omega_i$，得到尽可能准确的数据驱动模型A，以达到 $ A(feature \enspace of \enspace \Omega_i) \approx E(\Omega_i)$。这个模型A可以是统计模型如多元回归、传统机器学习模型如随机森林、深度学习方法如LSTM等。A可以是一个模型集，比如对于不同类型（根据层级不同、所在地理位置不同、流域土地利用类型不同等）的河段分别建立不同的模型。由于对河段的水质进行了显式的分解，而各个河段所在小集水区的$E(\Omega_i)$不存在真实的定量测量数据。所以针对这个场景本研究设计了迭代进化算法。

- 迭代起点：模型$A_0$，理论上迭代的起点可以从空模型（输出为0）开始，但是为了减少迭代的轮数，这个初始模型应该尽可能接近最终模型，即尽可能准确地达到$ A_0(feature \enspace of \enspace \Omega_i) \approx E(\Omega_i)$，为了接近这一点，本研究选择了所在河段尽可能靠近源头河段的水质监测站点，根据这些站点的数据关系训练出$ A_0(feature \enspace of \enspace \Omega_i) \approx y^{True}(\Omega_i)$，虽然真实的$E(\Omega_i)$未知，但是在尽可能靠近源头河段的河段上，上游的影响相对较小，即$y^{up}(\Omega_i) \to 0$，此时水质站点的监测值与我们想拟合的对象$E(\Omega_i)$较为接近

- 迭代终点：模型$A_n$，满足在所有的测试水质站点所在河段上，做到

$$A_n(feature \enspace of \enspace \Omega_i) \to E^{True}(\Omega_i)$$

由于不存在真实监测数据$E^{True}(\Omega_i)$，我们需要设置条件使得其等价于

$${\hat{y}_n}^{up}(\Omega_i) + A_n(feature \enspace of \enspace \Omega_i) \to y^{True}(\Omega_i)$$

按我们的显式分解方程，$y^{True}(\Omega_i) = y^{{True\_up}}(\Omega_i) + E^{True}(\Omega_i)$，则上式等价于

$$\hat{y}_n^{up}(\Omega_i) + A_n(feature \enspace of \enspace \Omega_i) \to y^{{True\_up}}(\Omega_i) + E^{True}(\Omega_i)$$

要使得第一个等式等价于第三个等式，需要满足$ \hat{y}_n^{{up}}(\Omega_i) \to y^{{True\_up}}(\Omega_i)$，为此，本研究设计了逐层计算的汇流算法，使得该条件等价于：对于$\Omega_i$的所有上游$\Omega_j$，满足$A_{n}(feature \enspace of \enspace \Omega_j) \to E^{True}(\Omega_j)$，即满足模型$A_n$准确拟合各个河段所在集水区的局部水质影响，上游的影响计算可以分解为各个河段自身的局部影响的汇流。这意味着，通过我们设计的汇流算法，只需要在所有河段上满足第一个等式，就可以使得第一个等式与第二个等式等价。所以此时我们只需要通过等价的第二个等式来判断模型迭代的终点条件。通过损失函数如MSE、MAE等计算左右平均误差，来判断是否达成第二个等式即可。比如设置阈值使得$\frac{1}{N} \sum_{i=1}^N \left\| \hat{y}_n^{\text{up}}(\Omega_i) + A_n(\text{feature of} \ \Omega_i) - y^{\text{True}}(\Omega_i) \right\| \leq \varepsilon$作为终点条件。或者判断是否这一误差计算值已经根据轮次收敛。

- 迭代过程：对于第n层模型，在所有监测站点所在河段上验证是否达成上述的终点条件，如果达成，则退出迭代。$A_n$即为算法最终模型。如果不满足，则将此时$y^{True}(\Omega_i) - \hat{y}_n^{up}(\Omega_i)$的值当做标签，记录其为$E^{label}_{n}(\Omega_i)$，训练新的模型$A_{n+1}$以达到对于标签的拟合。$E^{label}_{n}(\Omega_i)$的实际含义可以试做在第n层迭代中，对于$E^{True}(\Omega_i)$的中间近似值。随着迭代轮次n的增加，二者会愈发逼近。直到达到终点时，满足第二个等式，则此时满足$A_n(feature \enspace of \enspace \Omega_i) \to E^{label}_{n}(\Omega_i) \to E^{True}(\Omega_i)$。在终点条件达成前，需要朝这一目标进行迭代，即建立新的数据驱动模型，使得$A_{n+1}(feature \enspace of \enspace \Omega_i) \approx E^{label}_{n}(\Omega_i)$，再将模型$A_{n+1}$应用于下一轮迭代中。

### 汇流算法

对于每一层迭代的模型计算过程中的河段$\Omega_i$，考虑来自上游河段的负荷和本河段集水区的本地负荷，对河段 $\Omega_i$，其n层迭代的水质计算值由上游流入的浓度贡献 $y_n^{\text{up}}(\Omega_i)$ 和本地浓度贡献 $E_n(\Omega_i)$ 组成：

$$y_n(\Omega_i) = y_n^{\text{up}}(\Omega_i) + E_n(\Omega_i)$$

本地浓度贡献 $E_n(\Omega_i)$ 由第n层训练好的数据驱动模型$A_n$计算得到。

$$E_n(\Omega_i) = A_n(feature \enspace of \enspace \Omega_i)$$

特别地，当河段$\Omega_i$是源头河段，不存在上游河段时，河段的来自上游水质贡献$y_n^{\text{up}}(\Omega_i)$为0，此时河段的水质只包括本地浓度贡献$E_n(\Omega_i)$，完全由第n次迭代的数据驱动模型$A_n$计算得到。

本层的**上游的汇流贡献 $y_n^{\text{up}}(\Omega_i)$** 由所有上游河段输入的负荷总和除以本河段的流量得到：

$$y_n^{\text{up}}(\Omega_i) = \frac{\sum_{\Omega_j \in N(\Omega_i)} L_t(\Omega_i, \Omega_j)}{Q(\Omega_i)}$$

其中：

- $N(\Omega_i)$ 表示 $\Omega_i$ 的所有直接上游河段的集合。对于Headbasin，不存在直接上游河段，则 $y_n^{\text{up}}(\Omega_i)$为0。对于其他河段，直接上游的河段数量绝大多数为2（超过99.99\%），极少数为3，最大为4。
- $L_n(\Omega_i, \Omega_j)$ 是从上游河段 $\Omega_j$ 向下游河段 $\Omega_i$ 传递的总负荷，根据上游的水质乘以流量得到。上游的水质 $y_n(\Omega_j)$是之前使用汇流算法得到的。所以整个计算流程是从Headbasin开始向下游河段递推计算过程。

$$L_n(\Omega_i, \Omega_j) = y_n(\Omega_j) \cdot R(\Omega_j, \Omega_i) \cdot Q(\Omega_j)$$

$R(\Omega_j, \Omega_i)$ 表示上游河段 $\Omega_j$ 的水质被传递到下游河段 $\Omega_i$ 时的保留系数。水流在河段间流动时，受到反硝化、沉降以及生物吸收等作用，会产生相关损耗。根据已有的建模理论，从 $\Omega_j$流到$\Omega_i$的过程，考虑系统滞留的时候视作经过半个$\Omega_j$和半个$\Omega_i$，保留系数计算如下，保留的意思是，留在水流中的，而非留在系统中的，后者我们称为从水体中去除，从水体中去除也就是保留在系统中。我们这里的保留系数指的是保留在水体中而非系统中：

$$R(\Omega_j, \Omega_i) = \left( \exp \left( -\frac{v_f \cdot S(\Omega_j)}{2 \cdot Q(\Omega_j)} \right) \right) \cdot \left( \exp \left( -\frac{v_f \cdot S(\Omega_i)}{2 \cdot Q(\Omega_i)} \right) \right)$$

其中：

- $v_f$ 是吸收速率。对于TN，$v_{f,N} = 35f(t)f(C_N)$, 基础的吸收速率为35$m yr^{-1}$，$f(t)$ 表示温度的影响，$f(t) = \alpha \, t^{-20}$，$f(C_N)$描述了高氮负载情况下由于电子供体限制而导致的浓度对反硝化的影响，这个关系式从相关文章中找到，对于TP，则不存在反硝化，$v_{f,P} = 44.5f(t)$,基础的吸收速率为44.5$m yr^{-1}$,受温度影响的关系式与TN相同。对于系数$\alpha$, 对于TN为1.0717，对TP为1.06
- $S(\Omega_j)$ 和 $S(\Omega_i)$ 是河段 $\Omega_j$ 和 $\Omega_i$ 的面积。河段面积由河道长度和河道的宽度估计值得到。河道宽度根据文献估计如下：$ W = a Q^{b} $,即$lnW = lna + blnQ$，根据原文章对于美国的河道估计，大概拟合为$lnW = 2.10 + 0.45lnQ$，我们采用此式计算并根据遥感图像获取部分河道数据进行验证即可。也可以用现成的河道宽度数据集。
- $Q(\Omega_j)$ 和 $Q(\Omega_i)$ 是河段的流量。